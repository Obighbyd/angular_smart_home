const char SCRIPT_JS[] PROGMEM = R"=====(
var app=angular.module('myApp',['ngMaterial','ngCookies']);myDash.$inject=['$scope','$mdToast','$http','$interval','$sce','$cookies','$timeout'],angular.module('myApp').controller('dash',myDash).config(['$mdThemingProvider',function(a){a.theme('custom').primaryPalette('blue-grey').accentPalette('deep-orange')}]);function myDash(a,b,e,f,g,h,j){a.time_of_day='--',a.next_event_due='--',a.app_name='--',a.app_version='--',a.is_dst=!1,a.is_skipping_next=!1,a.is_powered=!1,a.is_using_timer=!1,a.last_action='--',a.events=[],a.doAction=function(k){var m='';switch(k){case'toggle':a.is_powered=!a.is_powered;case'relay':m='?relay='+(a.is_powered?'true':'false');break;case'timer':m='?timer='+(a.is_using_timer?'true':'false');break;case'skip':m='?skip='+(a.is_skipping_next?'true':'false');break;default:alert('did not understand');}e.get('action.php'+m).then(function(n){a.showToast(n.data.message)})},a.showToast=function(k){b.show(b.simple().textContent(k).position('top right'))},a.getStatus=function(){e.get('status.php').then(function(k){console.log('received',k.data),a.updateUI(k.data)})},a.getPowerStyle=function(){if(!a.is_powered)return{color:'rgba(255, 255, 255, 0.3)'}},a.updateUI=function(k){a.time_of_day=k.time_of_day,a.last_action=k.last_action,a.app_name=k.app_name,a.is_dst=k.is_dst,a.is_using_timer=k.is_using_timer,a.is_powered=k.is_powered,a.is_skipping_next=k.is_skipping_next,a.next_event_due=k.next_event_due,a.app_version=k.app_version,a.events=k.events,a.showToast('Synchronised')},a.getStatus(),f(function(){a.getStatus()},10000),a.loc_detect_devices=function(){h.put('loc_ip_range_start',a.loc.ip_range_start),h.put('loc_ip_range_end',a.loc.ip_range_end),a.loc.ips_to_check=[],a.loc.ips_counted=0,a.loc.replace_detected&&(a.loc.devices=[]);for(var l=a.loc.ip_range_start;l<=a.loc.ip_range_end;l++)a.loc.ips_to_check.push({ip_address:'http://192.168.0.'+l,checked:!1,result:'Held in queue'});a.loc.ips_checked=0,a.loc.ip_scan_percentage=0,j(function(){a.loc_try_next_in_list()},1000),a.loc_doStore()},a.loc_try_next_in_list=function(){for(var k=0;k<a.loc.ips_to_check.length;k++)if(a.loc.ips_to_check[k].checked);else{console.log('kicking off a test for ',a.loc.ips_to_check[k]);var l=a.loc.ips_to_check[k].ip_address+'/features.json',m=g.trustAsResourceUrl(l);let n=k;return a.loc.ips_to_check[n].result='waiting for response...',e.jsonp(m,{jsonpCallbackParam:'callback',timeout:1e4}).then(function(p){console.log('got something!',p.data),a.loc.devices.push(p.data),a.loc.ips_to_check[n].result='Found device',a.loc.store_detected&&a.loc_doStore()}).catch(function(){console.log('checked off:',n),a.loc.ips_to_check[n].result='No response'}),a.loc.ips_to_check[k].checked=!0,a.loc.ips_checked++,a.loc.ip_scan_percentage=parseInt(100*(a.loc.ips_checked/a.loc.ips_to_check.length)),void j(function(){a.loc_try_next_in_list()},2000)}console.log('all sites done.')},a.remoteRequest=function(k,l,m,n){var o='http://'+k+'/'+(n?m:l);console.log('requesting: '+o),trustedUrl=g.trustAsResourceUrl(o),e.jsonp(trustedUrl,{jsonpCallbackParam:'callback'}).then(function(q){console.log(q.data),a.showToast(q.data.message)}).catch(function(){})},a.getUUID=function(){var k=new Date().getTime();window.performance&&'function'==typeof window.performance.now&&(k+=performance.now());var l='xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(m){var n=0|(k+16*Math.random())%16;return k=Math.floor(k/16),('x'==m?n:8|3&n).toString(16)});return l},a.loc_doStore=function(){localStorage.setItem('loc_devices',JSON.stringify(a.loc.devices))},a.tpl_authenticate=function(){a.tpl.UUID=a.getUUID();var k={method:'login',params:{appType:'Kasa_Android',cloudUserName:a.tpl.username,cloudPassword:a.tpl.password,terminalUUID:a.tpl.UUID}};e.post('https://wap.tplinkcloud.com/',k).then(function(m){a.tpl.token=m.data.result.token,h.put('tpl_uuid',a.tpl.UUID),a.tpl.store_credentials?(h.put('tpl_username',a.tpl.username),h.put('tpl_password',a.tpl.password),h.put('tpl_store_credentials',!0)):(h.remove('tpl_username'),h.remove('tpl_password'),h.remove('tpl_store_credentials')),a.tpl.store_token?(h.put('tpl_token',a.tpl.token),h.put('tpl_store_token',!0)):(h.remove('tpl_token'),h.remove('tpl_store_token')),a.tpl_refreshDevices()},function(m){a.myWelcome=m.statusText})},a.tpl_refreshDevices=function(){e.post('https://wap.tplinkcloud.com?token='+a.tpl.token,{method:'getDeviceList'}).then(function(m){if(a.tpl.devices=m.data.result.deviceList,console.log(a.tpl.devices),a.tpl.devices.length){for(var n=0;n<a.tpl.devices.length;n++)a.tpl_getState(n);a.selected_tab_index=0}})},a.tpl_getState=function(k){var l=a.tpl.devices[k].appServerUrl,m=a.tpl.devices[k].deviceId;e.post(l+'?token='+a.tpl.token,{method:'passthrough',params:{deviceId:m,requestData:'{"system":{"get_sysinfo":null},"emeter":{"get_realtime":null}}'}}).then(function(p){window.response=p;var q=JSON.parse(p.data.result.responseData).system.get_sysinfo.relay_state;console.log(k,q,p),a.tpl.devices[k].is_powered=!0==q})},a.tpl_setState=function(k,l){var m=a.tpl.devices[k].appServerUrl,n=a.tpl.devices[k].deviceId,o={method:'passthrough',params:{deviceId:n,requestData:'{"system":{"set_relay_state":{"state":'+(l?1:0)+'}}}'}};e.post(m+'?token='+a.tpl.token,o).then(function(q){window.response=q,console.log(q)})},a.cookieOrValue=function(k,l){var m=h.get(k);return'undefined'==typeof m?l:m},a.tpl={},a.tpl.refresh_rate=60,a.tpl.devices=[],a.tpl.store_token='true'==h.get('tpl_store_token'),a.tpl.store_credentials='true'==h.get('tpl_store_credentials'),a.tpl.UUID=h.get('tpl_uuid'),a.tpl.store_credentials&&(a.tpl.username=h.get('tpl_username'),a.tpl.password=h.get('tpl_password')),a.tpl.store_token&&(a.tpl.token=h.get('tpl_token')),a.loc={},a.loc.store_detected=!0,a.loc.devices=JSON.parse(localStorage.getItem('loc_devices')),null==a.loc.devices&&(a.loc.devices=[]),a.loc.ip_range_start=parseInt(a.cookieOrValue('loc_ip_range_start',2)),a.loc.ip_range_end=parseInt(a.cookieOrValue('loc_ip_range_end',255)),a.loc.ip_range_end=parseInt(a.cookieOrValue('loc_ip_range_end',255)),a.selected_tab_index=0,'undefined'==typeof a.tpl.token?a.tpl.token='':a.tpl_refreshDevices(),f(function(){for(var k=0;k<a.tpl.devices.length;k++)a.tpl_getState(k)},1e3*a.tpl.refresh_rate)}
)=====";
